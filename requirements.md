# ミニバスケットボール用スタッツ記録PWA 設計要件

## プロジェクト概要
ミニバスケットボール用のスタッツ記録PWA（プログレッシブWebアプリ）をReactで開発する。
1名の記録員がiPad（メイン）またはスマートフォン（サブ）で試合を見ながら、リアルタイムに自チームのスタッツを入力・オフライン保存できることが目標。

## 技術スタック
* フロントエンド: React (Vite) + TypeScript
* スタイリング: Tailwind CSS v4
* 状態管理: Zustand
* 永続化: LocalStorage（オフラインキャッシュ） + Cloudflare D1（クラウドDB）
* アイコン: Lucide React
* PWA: vite-plugin-pwa (Workbox)

## インフラ構成
* ホスティング: Cloudflare Pages（静的SPA配信）
* API: Cloudflare Pages Functions（`functions/` ディレクトリ）
* データベース: Cloudflare D1（SQLite）
* 認証: シンプルなAPIキー方式（環境変数 `API_KEY`）

## データモデル定義

```typescript
type Action = 'SHOT' | 'FT' | 'REB' | 'FOUL' | 'AST';
type ShotResult = 'MAKE' | 'MISS';
type ReboundResult = 'OFF' | 'DEF';
type Result = ShotResult | ReboundResult | string; // ファウル種別含む

type Quarter = 1 | 2 | 3 | 4 | 5; // 5は延長

interface Game {
  id: string;          // UUID
  opponentName: string;
  gameDate: string;    // ISO 8601 日付
  opponentScore: number;
  createdAt: number;
}

interface Player {
  id: string;          // UUID
  number: number;      // 背番号
  name: string;
  createdAt: number;
}

interface GamePlayer {
  gameId: string;
  playerId: string;
  isActiveQ1: boolean; // 各クォーターの出場フラグ
  isActiveQ2: boolean;
  isActiveQ3: boolean;
  isActiveQ4: boolean;
  isActiveQ5: boolean;
}

interface Log {
  id: string;          // UUID
  gameId: string;
  quarter: Quarter;
  playerId: string;
  action: Action;
  zoneId: number | null; // 1-9 (FT/ASTの場合はnull)
  result: Result;
  timestamp: number;   // 入力時のシステム日時

  // AST専用フィールド
  passerPlayerId?: string;   // アシストした選手
  scorerPlayerId?: string;   // 得点した選手
  linkedShotLogId?: string;  // 紐付くシュート成功ログID
}
```

## 9分割コート（ゾーンマップ）

操作しやすさを優先し、3PTライン付近までを主対象として9ゾーンで記録する。  
見た目はJBA/FIBAハーフコートに近いコート線を表示しつつ、入力はリング（距離）ベースで分割する。

```
  Ring 1（最短距離）: [1]
  Ring 2（ペイント周辺）: [2][3][4]
  Ring 3（ミドル〜3PT付近）: [5][6][7][8][9]
```

※ 画面上の表示ラベルは数字（1〜9）のみとする。

## 画面構成とルーティング

| パス | 画面名 | 概要 |
|------|--------|------|
| `/` | 試合一覧 | 過去の試合リスト、新規作成、クラウド同期ボタン |
| `/settings` | 選手管理 | チームロスターのCRUD（背番号・名前） |
| `/games/new` | 試合セットアップ | 対戦相手名・日付入力、ベンチ入り＆先発5名選択 |
| `/games/:id/record` | 試合記録（メイン） | 1画面完結のスタッツ入力SPA |
| `/games/:id` | 試合詳細 | スタッツサマリー表示、CSVエクスポート |

## UI/UX設計（レスポンシブ要件）

### iPad用レイアウト (横画面/md以上)
3ペイン構成:
* 左 (20%): 出場中選手（5名）のボタングループ
* 中央 (50%): 9分割ハーフコート（タップでzoneIdを取得するUI領域）
* 右 (30%): アクション＆結果ボタングループ

### スマートフォン用レイアウト (縦画面/md未満)
縦積み構成 (スクロールなしで1画面に収める):
* 上部 (40%): 9分割ハーフコート
* 中部 (30%): アクション＆結果ボタン
* 下部 (30%): 出場中選手（5名）のボタングループ

### ヘッダー（共通）
* 戻るボタン（←）
* クォーター切り替えトグル（1Q〜4Q, OT）
* 「次Qへ」ボタン（出場選手選択モーダルが開く）
* スコア表示（自チーム得点は自動計算、相手は手動+1/-1ボタン）
* ステップインジケーター（ゾーン→アクション→選手）
* リセット / Undo / スタッツ / 試合終了 ボタン

## コア機能・ロジック

### 入力フロー
「コートのゾーン(zoneId)をタップ」→「アクション・結果(action/result)をタップ」→「選手(playerId)をタップ」の順で一時状態を保持し、3要素が揃った時点でlogs配列に保存する。
FT（フリースロー）の場合はゾーン選択をスキップ（zoneId = null）。

入力順序の制御:
* ステップ外のUIは操作不可（非活性表示）
* 1つ前のステップを完了しない限り次ステップへ進めない

### Undo機能
直前の入力を1つ取り消す（pop）ボタンを常時表示。
シュート成功（SHOT MAKE）を取り消した場合、紐付くアシストログも自動的に削除される。

### クォーター管理
* 各クォーターの出場選手5名をGamePlayerテーブルで管理
* 「次Qへ」ボタンを押すと、次のクォーターの出場選手を選択するモーダルが表示される
* 選手未設定のクォーターに移動した場合も自動的にモーダルを表示
* 選手未設定時は画面上部に警告バーを表示

### 試合終了フロー
「試合終了」ボタン（確認ダイアログ付き）押下時に、まずクラウド同期（Push）を実行し、その後に試合詳細画面（`/games/:id`）へ遷移する。

### スタッツ集計ビュー
logs配列から以下を計算して表示するモーダル:
* チーム合計得点
* 選手ごとのシュート成功率（FG%）
* 選手ごとのFT成功率（FT%）
* 選手ごとのリバウンド数（ORB / DRB）
* 選手ごとのアシスト数（AST）
* 選手ごとのファウル数

### 試合詳細画面（タブ分析）
試合詳細画面では、選手プルダウン（チーム全体 / 個別選手）と3つのタブで分析を表示:
* **FG%タブ**: コートSVG上にゾーン別シュート成功率をヒートマップ表示（色: 高確率=緑 / 中間=黄 / 低確率=赤 / 試投なし=灰）
* **REBタブ**: コートSVG上にゾーン別リバウンド分布をヒートマップ表示（色: 青の濃淡、ORB/DRB内訳付き）
* **ASTタブ**: アシスト一覧（クォーター、パサー→スコアラーの組み合わせ）

### アシスト入力フロー
シュート成功（SHOT MAKE）直後にアシスト入力ポップアップを自動表示:
* 得点者以外のアクティブ選手一覧からパサーを選択
* 「アシストなし」ボタンでスキップ可能（任意入力）
* 選択されたアシストはASTログとして保存（linkedShotLogIdで成功シュートと紐付け）

### CSVエクスポート
試合詳細画面およびスタッツモーダルから、選手別スタッツをCSV形式でダウンロード可能。BOM付きUTF-8で出力。AST列を含む。

## オフライン同期戦略

1. 全ての書き込みはまずLocalStorageに保存（即座にUIに反映）
2. アプリ起動時（オンライン時）にWorkers API経由でD1からPullし、最新データを反映
3. 「試合終了」ボタン押下時にWorkers API経由でD1へPush
4. ホーム画面から手動Push/Pullも可能（運用補助）
5. 同期状態をUI上にインジケーターで表示（最終同期日時）
6. 安全策として「クラウドが空でローカルにデータあり」の場合はローカルを上書きしない

## 今後の拡張方針（複数入力者）

2〜3人で同一試合を扱う将来拡張として、以下を想定する:

* リアルタイムは厳密な常時双方向通信ではなく、2〜3秒間隔の差分ポーリング方式を採用
* イベント単位での保存（1入力=1レコード）と差分取得API（`since` 付き）で通信量を抑制
* 無料枠運用を優先し、必要になるまでWebSocket/Durable Objectsは導入しない

## アクション種別の設計方針

* SHOT（シュート）、FT（フリースロー）、REB（リバウンド）、FOUL（ファウル）、AST（アシスト）の5種
* REB入力ではゾーン選択が必須（取得位置を記録）。入力フロー: ゾーン→ORB/DRB→選手
* AST入力はシュート成功直後のポップアップで任意入力。パサー→スコアラーの関係を記録
* ターンオーバー・スティール・ブロックは、1名での操作におけるデータ整合性を考慮し意図的に省略
* 相手チームのスタッツは記録しない（スコアのみ手動入力）
